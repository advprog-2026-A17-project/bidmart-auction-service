<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BidMart - Auction Interface</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f7f6;
            margin: 0;
            padding: 40px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .dashboard-container {
            background: #ffffff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 750px;
        }
        h1 {
            color: #1a202c;
            text-align: center;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 15px;
        }
        ul {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }
        li {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            margin-bottom: 15px;
            padding: 20px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: box-shadow 0.2s;
        }
        li:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .item-details {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
            color: white;
            text-transform: uppercase;
        }
        .status-ACTIVE { background-color: #48bb78; }
        .status-EXTENDED { background-color: #ed8936; }
        .status-CLOSED { background-color: #e53e3e; }

        .interaction-section {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .price {
            font-weight: 700;
            color: #2b6cb0;
            font-size: 1.2rem;
            min-width: 100px;
            text-align: right;
        }
        .bid-input {
            width: 90px;
            padding: 8px;
            border: 1px solid #cbd5e0;
            border-radius: 6px;
        }
        .bid-button {
            background-color: #3182ce;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-weight: bold;
            cursor: pointer;
        }
        .bid-button:hover { background-color: #2b6cb0; }
        .bid-button:disabled {
            background-color: #a0aec0;
            cursor: not-allowed;
        }
        .toast-error {
            color: #c53030;
            background-color: #fed7d7;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: none;
            font-weight: bold;
        }
    </style>
</head>
<body>

<div class="dashboard-container">
    <h1>BidMart Live Auctions</h1>
    <div id="error-toast" class="toast-error"></div>
    <ul id="auction-list">
        <li style="justify-content: center; color: #718096;">Fetching data from PostgreSQL/H2...</li>
    </ul>
</div>

<script>
    window.addEventListener('DOMContentLoaded', fetchRealData);

    async function fetchRealData() {
        const auctionListElement = document.getElementById('auction-list');
        const errorToast = document.getElementById('error-toast');

        try {
            const response = await fetch('http://localhost:8080/api/auctions');
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

            const auctions = await response.json();
            auctionListElement.innerHTML = '';

            if (auctions.length > 0) {
                auctions.forEach(auction => {
                    const li = document.createElement('li');

                    const isClosed = auction.status === 'CLOSED';
                    const disabledAttr = isClosed ? 'disabled' : '';

                    const minNextBid = auction.currentHighestBid + auction.minIncrement;

                    li.innerHTML = `
                        <div class="item-details">
                            <strong>${auction.itemName}</strong>
                            <small style="color: #718096;">Item ID: ${auction.itemId}</small>
                            <div><span class="status-badge status-${auction.status}">${auction.status}</span></div>
                            <small style="color: #a0aec0;">Min Increment: $${auction.minIncrement.toFixed(2)} | Ends: ${new Date(auction.endTime).toLocaleString()}</small>
                        </div>
                        <div class="interaction-section">
                            <span class="price">$${auction.currentHighestBid.toFixed(2)}</span>
                            <input type="number" id="input-${auction.id}" class="bid-input" value="${minNextBid}" step="${auction.minIncrement}" min="${minNextBid}" ${disabledAttr}>
                            <button class="bid-button" onclick="placeRealBid(${auction.id})" ${disabledAttr}>Place Bid</button>
                        </div>
                    `;
                    auctionListElement.appendChild(li);
                });
            } else {
                auctionListElement.innerHTML = '<li style="justify-content: center;">Database is empty. Check DataSeeder.</li>';
            }
        } catch (error) {
            console.error('Fetch execution failed:', error);
            errorToast.textContent = 'Failed to connect to backend. Ensure Spring Boot is running.';
            errorToast.style.display = 'block';
        }
    }

    async function placeRealBid(auctionId) {
        const amountInput = document.getElementById(`input-${auctionId}`);
        const amount = parseFloat(amountInput.value);
        const errorToast = document.getElementById('error-toast');

        try {
            const response = await fetch(`http://localhost:8080/api/auctions/${auctionId}/bid?amount=${amount}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            if (!response.ok) {
                const errorMsg = await response.text();
                throw new Error(errorMsg);
            }

            errorToast.style.display = 'none';
            await fetchRealData();

        } catch (error) {
            console.error('Bidding failed:', error);
            errorToast.textContent = `Transaction Failed: ${error.message}`;
            errorToast.style.display = 'block';
        }
    }
</script>

</body>
</html>